<div class="prediction-container" style="max-width: 500px; margin: 0 auto; padding: 20px; font-family: sans-serif; background-color: #D3D3D3; min-height: 100vh;">
  
  <div style="text-align: center; margin-bottom: 20px;">
    <h2 style="color: #333; margin: 0;"><%= @competition.name %></h2>
    <p style="color: #666; font-size: 14px;">予想を投稿しよう！</p>
  </div>

  <%# --- 修正点1: urlを固定せずRailsの自動判定に任せ、IDを隠しフィールドで送る --- %>
  <%= form_with model: @prediction, local: true, data: { turbo: false } do |f| %>
    
    <%# --- 重要：どのイベントの予想かという情報を裏で持たせる --- %>
    <%= f.hidden_field :competition_id, value: @competition.id %>
    
    <div style="margin-bottom: 30px;">
      <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #333;">名前（またはタイトル）</h2>
      <%= f.text_field :name, placeholder: "例：私の予想", required: true, style: "width: 100%; padding: 12px; border: 1px solid #999; border-radius: 4px; font-size: 18px; box-sizing: border-box; background: white;" %>
    </div>

    <div id="prediction-items-container">
      <%= f.fields_for :ranking_items do |item_f| %>
        <div class="prediction-item" style="margin-bottom: 25px;">
          <h3 class="item-number" style="background-color: #B0B0B0; display: inline-block; padding: 5px 20px; font-size: 18px; margin-bottom: 10px; border: 1px solid #888; font-weight: bold;">
            <%= item_f.index + 1 %>番目
          </h3>
          
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; background: #fff; padding: 8px; border: 1px solid #999;">
            <% [
              "#FF0000", "#0000FF", "#00FFFF", "#FFFF00", "#FFA500", "#008000", 
              "#800000", "#FFFFFF", "#B8860B", "#000000", "#ADFF2F", "#000080"
            ].each do |color_code| %>
              <label style="cursor: pointer;">
                <%= item_f.radio_button :color_code, color_code, class: "swatch-radio" %>
                <div class="swatch-cell" style="background-color: <%= color_code %>; width: 100%; aspect-ratio: 1/1; border: 1px solid #ccc; box-sizing: border-box;"></div>
              </label>
            <% end %>
          </div>
          <%= item_f.hidden_field :rank, value: item_f.index + 1, class: "rank-input" %>
        </div>
      <% end %>
    </div>

    <%# --- 枠を増やすボタン --- %>
    <div style="text-align: center; margin-bottom: 30px;">
      <button type="button" id="add-item-button" style="background: #555; color: white; border: none; padding: 12px 24px; border-radius: 30px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #333;">
        ＋ 順位を追加する
      </button>
    </div>

    <div style="margin-top: 50px; text-align: center;">
      <div style="background-color: #E0E0E0; border: 3px solid #000; padding: 20px; display: inline-block; width: 100%; box-sizing: border-box;">
        <p style="font-weight: bold; font-size: 20px; margin-bottom: 10px; color: #000;">後戻りできないよ！</p>
        <%= f.submit "保存", style: "background: none; border: none; font-size: 32px; font-weight: bold; cursor: pointer; width: 100%; color: #000;" %>
      </div>
      <%= link_to "キャンセル", predictions_path(competition_id: @competition.id), style: "display: block; margin-top: 20px; color: #666; text-decoration: none;" %>
    </div>
  <% end %>
</div>

<style>
  .swatch-radio { display: none; }
  .swatch-radio:checked + .swatch-cell { outline: 4px solid #000; outline-offset: -4px; position: relative; z-index: 1; }
  .swatch-cell[style*="#FFFFFF"] { border: 1px solid #aaa !important; }
  #add-item-button:active { transform: translateY(2px); box-shadow: 0 2px 0 #333; }
</style>

<script>
  const initAddButton = () => {
    const addButton = document.getElementById("add-item-button");
    const container = document.getElementById("prediction-items-container");
    if (!addButton || !container) return;

    addButton.replaceWith(addButton.cloneNode(true));
    const newAddButton = document.getElementById("add-item-button");

    newAddButton.addEventListener("click", () => {
      const items = container.querySelectorAll(".prediction-item");
      const nextIndex = items.length;
      const firstItem = items[0];
      const newItem = firstItem.cloneNode(true);
      
      newItem.querySelector(".item-number").innerText = (nextIndex + 1) + "番目";
      
      const inputs = newItem.querySelectorAll("input");
      inputs.forEach(input => {
        // competition_idフィールドは書き換えないようにガード
        if (input.name.includes("competition_id")) return;

        input.name = input.name.replace(/\[\d+\]/, `[${nextIndex}]`);
        input.id = input.id.replace(/_\d+_/, `_${nextIndex}_`);
        
        if (input.type === "radio") {
          input.checked = false;
          input.id += `_${Math.random().toString(36).substr(2, 5)}`;
        }
        if (input.classList.contains("rank-input")) {
          input.value = nextIndex + 1;
        }
      });

      container.appendChild(newItem);
    });
  };

  document.addEventListener("DOMContentLoaded", initAddButton);
  document.addEventListener("turbo:load", initAddButton);
</script>